{% extends "base.html" %}

{% block title %}Gerenciar Tabelas do Sistema - GestãoPRO{% endblock %}

{% block content %}
<div id="notification-area"></div>

<header class="main-header">
    <h1>Gerenciar Tabelas do Sistema</h1>
    <p class="subtitle">Adicione, edite ou exclua os dados mestres do sistema.</p>
</header>

<div class="management-container">
    <aside class="management-sidebar">
        <nav>
            {# O loop 'tabelas' é fornecido pelo contexto Flask, mantido #}
            {% for key, config in tabelas.items() %}
                <a href="#" class="management-link" data-tabela="{{ key }}" data-nome-exibicao="{{ config.tabela|replace('_', ' ')|title }}">
                    {{ config.tabela|replace('_', ' ')|title }}
                </a>
            {% endfor %}
        </nav>
    </aside>

    <main class="management-content">
        <div id="content-area">
            <div class="empty-state">
                <i class="fa-solid fa-arrow-left"></i>
                <h2>Selecione uma tabela</h2>
                <p>Escolha uma das tabelas no menu à esquerda para começar a gerenciar.</p>
            </div>
        </div>

        {# INCLUSÃO DO TEMPLATE DA TABELA (Substitui o bloco <template>) #}
        {% include '_tabela_generica_crud.html' %}
        
    </main>
</div>

{# INCLUSÃO DO MODAL #}
{% include '_modal_generica_crud.html' %}

{% endblock %}
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    let tabelaAtiva = null;
    let nomeExibicaoTabelaAtiva = null;

    const contentArea = document.getElementById('content-area');
    const tableTemplate = document.getElementById('table-template');
    const modal = document.getElementById('modal-item');
    const modalTitulo = document.getElementById('modal-titulo');
    const formItem = document.getElementById('form-item');
    const inputNomeItem = document.getElementById('item-nome');
    let idItemEmEdicao = null;

    function showNotification(message, type = 'error') {
        const notificationArea = document.getElementById('notification-area');
        const existing = notificationArea.querySelector('.notification');
        if (existing) existing.remove();
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        notificationArea.appendChild(notification);
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.addEventListener('transitionend', () => notification.remove());
        }, 5000);
    }
    
    const fecharModal = () => {
        modal.style.display = 'none';
        formItem.reset();
        idItemEmEdicao = null;
    };


    // --- FUNÇÕES PRINCIPAIS DE UX ---

    async function carregarTabela(nomeTabela, nomeExibicao) {
        tabelaAtiva = nomeTabela;
        nomeExibicaoTabelaAtiva = nomeExibicao;

        // Limpa a área de conteúdo e clona o template da tabela
        contentArea.innerHTML = '';
        const clone = tableTemplate.content.cloneNode(true);
        contentArea.appendChild(clone);

        document.getElementById('table-title').textContent = `Gerenciando: ${nomeExibicao}`;
        
        // Remove listeners antigos antes de adicionar o novo (previne duplicidade)
        const btnAdd = document.getElementById('btn-add-new-item');
        btnAdd.replaceWith(btnAdd.cloneNode(true));
        document.getElementById('btn-add-new-item').addEventListener('click', abrirModalParaNovo);

        const tableBody = document.getElementById('table-body');
        tableBody.innerHTML = '<tr><td colspan="3">Carregando...</td></tr>';

        try {
            // Chama a API que lista os itens (GET /api/tabelas-sistema/{nome_tabela})
            const response = await fetch(`/api/tabelas-sistema/${nomeTabela}`);
            const itens = await response.json();
            
            // Tratamento de resposta da API
            if (!response.ok) throw new Error(itens.detail || itens.erro || 'Erro desconhecido da API');

            tableBody.innerHTML = '';
            if (itens.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3"><div class="empty-state mini"><p>Nenhum item cadastrado.</p></div></td></tr>';
                return;
            }

            // Renderização da Tabela
            itens.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.nome}</td>
                    <td class="actions-cell">
                        <button class="btn-link-action" onclick="abrirModalParaEditar(${item.id}, '${item.nome.replace(/'/g, "\\'")}')"><i class="fa-solid fa-pencil"></i> Editar</button>
                        <button class="btn-link-action red" onclick="excluirItem(${item.id})"><i class="fa-solid fa-trash-can"></i> Excluir</button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        } catch (error) {
            tableBody.innerHTML = `<tr><td colspan="3" class="text-red">Erro ao carregar dados: ${error.message}</td></tr>`;
        }
    }

    function abrirModalParaNovo() {
        idItemEmEdicao = null;
        modalTitulo.textContent = `Adicionar Novo em ${nomeExibicaoTabelaAtiva}`;
        formItem.reset();
        modal.style.display = 'flex';
    }

    function abrirModalParaEditar(id, nomeAtual) {
        idItemEmEdicao = id;
        modalTitulo.textContent = `Editar Item em ${nomeExibicaoTabelaAtiva}`;
        inputNomeItem.value = nomeAtual;
        modal.style.display = 'flex';
    }

    formItem.addEventListener('submit', async function(event) {
        event.preventDefault();
        const nome = inputNomeItem.value.trim();
        
        if (!nome) { showNotification('O campo Nome é obrigatório.'); return; }
        
        const url = idItemEmEdicao 
            ? `/api/tabelas-sistema/${tabelaAtiva}/${idItemEmEdicao}` // PUT
            : `/api/tabelas-sistema/${tabelaAtiva}`; // POST
        const method = idItemEmEdicao ? 'PUT' : 'POST';

        const submitButton = this.querySelector('button[type="submit"]');
        submitButton.disabled = true;

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nome: nome })
            });
            const resultado = await response.json();
            
            if (!response.ok) throw new Error(resultado.detail || resultado.erro || 'Erro na API');
            
            showNotification(resultado.mensagem || `Item ${idItemEmEdicao ? 'atualizado' : 'criado'} com sucesso!`, 'success');
            
            fecharModal();
            // Recarrega o conteúdo da tabela ativa
            carregarTabela(tabelaAtiva, nomeExibicaoTabelaAtiva); 
            
        } catch (error) {
            showNotification(`Erro: ${error.message}`);
        } finally {
            submitButton.disabled = false;
        }
    });

    async function excluirItem(id) {
        if (!confirm('Tem certeza que deseja excluir este item? A ação não pode ser desfeita.')) return;
        
        try {
            const response = await fetch(`/api/tabelas-sistema/${tabelaAtiva}/${id}`, {
                method: 'DELETE'
            });
            
            // O DELETE no FastAPI retorna 204 NO CONTENT em caso de sucesso
            if (response.status === 204) {
                 showNotification('Item excluído com sucesso!', 'success');
            } else {
                 const resultado = await response.json();
                 if (!response.ok) throw new Error(resultado.detail || resultado.erro || 'Erro na exclusão');
                 // Se retornar 200/201 mas com mensagem, exibe.
                 showNotification(resultado.mensagem || 'Item excluído com sucesso!', 'success');
            }
            
            // Recarrega o conteúdo da tabela ativa
            carregarTabela(tabelaAtiva, nomeExibicaoTabelaAtiva); 
            
        } catch (error) {
            showNotification(`Erro ao excluir: ${error.message}`);
        }
    }

    // --- Inicialização e Listeners de UI ---
    document.querySelectorAll('.management-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelectorAll('.management-link').forEach(l => l.classList.remove('active'));
            link.classList.add('active');
            const nomeTabela = link.dataset.tabela;
            const nomeExibicao = link.dataset.nomeExibicao;
            carregarTabela(nomeTabela, nomeExibicao);
        });
    });
    
    document.getElementById('btn-fechar-modal').addEventListener('click', fecharModal);
    document.getElementById('btn-cancelar-modal').addEventListener('click', fecharModal);
    window.addEventListener('click', (event) => {
        if (event.target == modal) fecharModal();
    });

    // Torna as funções acessíveis globalmente para os botões da tabela (onclick=...)
    window.abrirModalParaEditar = abrirModalParaEditar;
    window.excluirItem = excluirItem;
});
</script>
{% endblock %}