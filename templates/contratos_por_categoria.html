{% extends "base.html" %}
{% from '_pagination.html' import render_pagination %}

{% block title %}Catálogo - {{ categoria.nome }}{% endblock %}

{% block content %}
<header class="main-header">
    <a href="{{ url_for('categorias_ui') }}" class="back-link">
        &larr; Voltar para a lista de categorias
    </a>
    <h1>Catálogo de Itens: <span class="text-blue">{{ categoria.nome }}</span></h1>
    <p class="subtitle">Visualize todos os itens disponíveis para esta categoria e inicie um novo pedido.</p>
</header>

<div class="card full-width">
    <div class="card-actions">
        <form method="GET" action="{{ url_for('contratos_por_categoria', id_categoria=categoria.id) }}" class="search-form">
            <i class="fa-solid fa-search search-icon"></i>
            <input type="search" name="busca" placeholder="Buscar por descrição do item..." value="{{ query_params.busca or '' }}" class="form-control">
            <button type="submit" class="btn btn-secondary">Buscar</button>
        </form>
        <a href="{{ url_for('novo_pedido_pagina', id_categoria=categoria.id) }}" class="btn btn-primary">
            <i class="fa-solid fa-cart-plus"></i>
            Iniciar Novo Pedido
        </a>
    </div>

    <div class="table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th class="sortable-header" style="width: 40%;">
                        {% set next_order = 'desc' if sort_by == 'descricao' and order == 'asc' else 'asc' %}
                        {% set params = query_params.copy() %}
                        {% set _ = params.update({'sort_by': 'descricao', 'order': next_order}) %}
                        <a href="{{ url_for('contratos_por_categoria', id_categoria=categoria.id, **params) }}">
                            Descrição do Item
                            {% if sort_by == 'descricao' %}<i class="fa-solid {{ 'fa-arrow-down-z-a' if order == 'desc' else 'fa-arrow-up-a-z' }}"></i>{% endif %}
                        </a>
                    </th>
                    <th class="sortable-header">
                        {% set next_order = 'desc' if sort_by == 'contrato' and order == 'asc' else 'asc' %}
                        {% set params = query_params.copy() %}
                        {% set _ = params.update({'sort_by': 'contrato', 'order': next_order}) %}
                        <a href="{{ url_for('contratos_por_categoria', id_categoria=categoria.id, **params) }}">
                            Instrumento Contratual de Origem
                            {% if sort_by == 'contrato' %}<i class="fa-solid {{ 'fa-arrow-down-z-a' if order == 'desc' else 'fa-arrow-up-a-z' }}"></i>{% endif %}
                        </a>
                    </th>
                    <th>Qtd. Contratada</th>
                    <th>Qtd. Pedida</th>
                    <th class="sortable-header text-green">
                        {% set next_order = 'desc' if sort_by == 'saldo' and order == 'asc' else 'asc' %}
                        {% set params = query_params.copy() %}
                        {% set _ = params.update({'sort_by': 'saldo', 'order': next_order}) %}
                        <a href="{{ url_for('contratos_por_categoria', id_categoria=categoria.id, **params) }}">
                            Saldo Disponível
                            {% if sort_by == 'saldo' %}<i class="fa-solid {{ 'fa-arrow-down-1-9' if order == 'desc' else 'fa-arrow-up-9-1' }}"></i>{% endif %}
                        </a>
                    </th>
                    <th class="sortable-header">
                        {% set next_order = 'desc' if sort_by == 'valor' and order == 'asc' else 'asc' %}
                        {% set params = query_params.copy() %}
                        {% set _ = params.update({'sort_by': 'valor', 'order': next_order}) %}
                        <a href="{{ url_for('contratos_por_categoria', id_categoria=categoria.id, **params) }}">
                            Valor Unit. (R$)
                            {% if sort_by == 'valor' %}<i class="fa-solid {{ 'fa-arrow-down-1-9' if order == 'desc' else 'fa-arrow-up-9-1' }}"></i>{% endif %}
                        </a>
                    </th>
                </tr>
            </thead>
            <tbody>
    {% for item in itens %}
    <tr>
        <td><strong>{{ item.descricao }}</strong></td>
        <td><a href="{{ url_for('detalhe_contrato', id_contrato=item.id_contrato) }}">{{ item.numero_contrato }}</a></td>
        
        <td>{% if item.quantidade == item.quantidade|int %}{{ item.quantidade|int }}{% else %}{{ "%.2f"|format(item.quantidade)|replace('.', ',') }}{% endif %}</td>
        
        <td>{% if item.total_pedido == item.total_pedido|int %}{{ item.total_pedido|int }}{% else %}{{ "%.2f"|format(item.total_pedido)|replace('.', ',') }}{% endif %}</td>
        
        <td class="{{ 'text-red' if item.saldo == 0 else 'text-green' }}" style="font-weight: 700;">
            {% if item.saldo == item.saldo|int %}{{ item.saldo|int }}{% else %}{{ "%.2f"|format(item.saldo)|replace('.', ',') }}{% endif %}
        </td>
        
        <td>{{ "%.2f"|format(item.valor_unitario) }}</td>
    </tr>
    {% endfor %}
</tbody>
        </table>
    </div>
    
    <div class="card-footer">
        {{ render_pagination(pagina_atual, total_paginas, 'contratos_por_categoria', {'id_categoria': categoria.id}, query_params) }}
    </div>
</div>
{% endblock %}