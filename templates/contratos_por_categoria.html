{% extends "base.html" %}
{% from '_pagination.html' import render_pagination %}

{% block title %}Catálogo - {{ categoria.nome }}{% endblock %}

{% block content %}
{# 1. INCLUSÃO DO COMPONENTE HEADER/ACTIONS #}
{% include '_contratos_por_categoria_header.html' %}

<div class="card full-width">
    
    <div class="table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th class="sortable-header" style="width: 40%;">
                        {% set next_order = 'desc' if sort_by == 'descricao' and order == 'asc' else 'asc' %}
                        {% set params = query_params.copy() %}
                        {% set _ = params.update({'sort_by': 'descricao', 'order': next_order}) %}
                        <a href="{{ url_for('contratos_por_categoria', id_categoria=categoria.id, **params) }}">
                            Descrição do Item
                            {% if sort_by == 'descricao' %}<i class="fa-solid {{ 'fa-arrow-down-z-a' if order == 'desc' else 'fa-arrow-up-a-z' }}"></i>{% endif %}
                        </a>
                    </th>
                    <th class="sortable-header">
                        {% set next_order = 'desc' if sort_by == 'contrato' and order == 'asc' else 'asc' %}
                        {% set params = query_params.copy() %}
                        {% set _ = params.update({'sort_by': 'contrato', 'order': next_order}) %}
                        <a href="{{ url_for('contratos_por_categoria', id_categoria=categoria.id, **params) }}">
                            Instrumento Contratual de Origem
                            {% if sort_by == 'contrato' %}<i class="fa-solid {{ 'fa-arrow-down-z-a' if order == 'desc' else 'fa-arrow-up-a-z' }}"></i>{% endif %}
                        </a>
                    </th>
                    <th class="text-right">Qtd. Contratada</th>
                    <th class="text-right">Qtd. Pedida</th>
                    <th class="sortable-header text-green text-right">
                        {% set next_order = 'desc' if sort_by == 'saldo' and order == 'asc' else 'asc' %}
                        {% set params = query_params.copy() %}
                        {% set _ = params.update({'sort_by': 'saldo', 'order': next_order}) %}
                        <a href="{{ url_for('contratos_por_categoria', id_categoria=categoria.id, **params) }}">
                            Saldo Disponível
                            {% if sort_by == 'saldo' %}<i class="fa-solid {{ 'fa-arrow-down-1-9' if order == 'desc' else 'fa-arrow-up-9-1' }}"></i>{% endif %}
                        </a>
                    </th>
                    <th class="sortable-header text-right">
                        {% set next_order = 'desc' if sort_by == 'valor' and order == 'asc' else 'asc' %}
                        {% set params = query_params.copy() %}
                        {% set _ = params.update({'sort_by': 'valor', 'order': next_order}) %}
                        <a href="{{ url_for('contratos_por_categoria', id_categoria=categoria.id, **params) }}">
                            Valor Unit. (R$)
                            {% if sort_by == 'valor' %}<i class="fa-solid {{ 'fa-arrow-down-1-9' if order == 'desc' else 'fa-arrow-up-9-1' }}"></i>{% endif %}
                        </a>
                    </th>
                </tr>
            </thead>
            <tbody>
    {% for item in itens %}
    <tr>
        <td><strong>{{ item.descricao }}</strong></td>
        <td><a href="{{ url_for('detalhe_contrato', id_contrato=item.id_contrato) }}">{{ item.numero_contrato }}</a></td>
        
        {# Qtd. Contratada - Alinhado à Direita, Formatação com vírgula #}
        <td class="text-right">{% if item.quantidade == item.quantidade|int %}{{ item.quantidade|int }}{% else %}{{ "%.2f"|format(item.quantidade)|replace('.', ',') }}{% endif %}</td>
        
        {# Qtd. Pedida - Alinhado à Direita, Formatação com vírgula #}
        <td class="text-right">{% if item.total_pedido == item.total_pedido|int %}{{ item.total_pedido|int }}{% else %}{{ "%.2f"|format(item.total_pedido)|replace('.', ',') }}{% endif %}</td>
        
        {# Saldo Disponível - Alinhado à Direita, Formatação com vírgula, Cor #}
        <td class="text-right {{ 'text-red' if item.saldo == 0 else 'text-green' }}" style="font-weight: 700;">
            {% if item.saldo == item.saldo|int %}{{ item.saldo|int }}{% else %}{{ "%.2f"|format(item.saldo)|replace('.', ',') }}{% endif %}
        </td>
        
        {# Valor Unitário - Alinhado à Direita, Formatação com vírgula #}
        <td class="text-right">{{ "%.2f"|format(item.valor_unitario)|replace('.', ',') }}</td>
    </tr>
    {% endfor %}
</tbody>
        </table>
    </div>
    
    <div class="card-footer">
        {{ render_pagination(pagina_atual, total_paginas, 'contratos_por_categoria', {'id_categoria': categoria.id}, query_params) }}
    </div>
</div>
{% endblock %}