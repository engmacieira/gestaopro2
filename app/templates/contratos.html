{% extends "base.html" %}
{% from '_pagination.html' import render_pagination %}

{% block title %}Contratos{% endblock %}

{% block content %}
{# 1. INCLUSÃO DO COMPONENTE HEADER/ACTIONS #}
{% include '_contratos_header.html' %}

<div class="card full-width" style="margin-top: 20px;">
    {% if contratos|length > 0 %}
    <div class="table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th class="sortable-header" style="width: 20%;">
                        {% set next_order = 'desc' if sort_by == 'numero_contrato' and order == 'asc' else 'asc' %}
                        {% set params = query_params.copy() %}
                        {% set _ = params.update({'sort_by': 'numero_contrato', 'order': next_order}) %}
                        <a href="{{ url_for('contratos_ui', **params) }}">
                            Nº Contrato
                            {% if sort_by == 'numero_contrato' %}<i class="fa-solid {{ 'fa-arrow-down-9-1' if order == 'desc' else 'fa-arrow-up-1-9' }}"></i>{% endif %}
                        </a>
                    </th>
                    <th class="sortable-header" style="width: 20%;">
                        {% set next_order = 'desc' if sort_by == 'processo_licitatorio' and order == 'asc' else 'asc' %}
                        {% set params = query_params.copy() %}
                        {% set _ = params.update({'sort_by': 'processo_licitatorio', 'order': next_order}) %}
                        <a href="{{ url_for('contratos_ui', **params) }}">
                            Processo Licitatório
                            {% if sort_by == 'processo_licitatorio' %}<i class="fa-solid {{ 'fa-arrow-down-z-a' if order == 'desc' else 'fa-arrow-up-a-z' }}"></i>{% endif %}
                        </a>
                    </th>
                    <th class="sortable-header" style="width: 25%;">
                        {% set next_order = 'desc' if sort_by == 'fornecedor' and order == 'asc' else 'asc' %}
                        {% set params = query_params.copy() %}
                        {% set _ = params.update({'sort_by': 'fornecedor', 'order': next_order}) %}
                        <a href="{{ url_for('contratos_ui', **params) }}">
                            Fornecedor
                            {% if sort_by == 'fornecedor' %}<i class="fa-solid {{ 'fa-arrow-down-z-a' if order == 'desc' else 'fa-arrow-up-a-z' }}"></i>{% endif %}
                        </a>
                    </th>
                    <th class="sortable-header text-right">
                        {% set next_order = 'desc' if sort_by == 'data_vigencia_fim' and order == 'asc' else 'asc' %}
                        {% set params = query_params.copy() %}
                        {% set _ = params.update({'sort_by': 'data_vigencia_fim', 'order': next_order}) %}
                        <a href="{{ url_for('contratos_ui', **params) }}">
                            Fim da Vigência
                            {% if sort_by == 'data_vigencia_fim' %}<i class="fa-solid {{ 'fa-arrow-down-9-1' if order == 'desc' else 'fa-arrow-up-1-9' }}"></i>{% endif %}
                        </a>
                    </th>
                    <th class="sortable-header text-center">
                        {% set next_order = 'desc' if sort_by == 'status_ativo' and order == 'asc' else 'asc' %}
                        {% set params = query_params.copy() %}
                        {% set _ = params.update({'sort_by': 'status_ativo', 'order': next_order}) %}
                        <a href="{{ url_for('contratos_ui', **params) }}">
                            Status
                            {% if sort_by == 'status_ativo' %}<i class="fa-solid {{ 'fa-arrow-down-z-a' if order == 'desc' else 'fa-arrow-up-a-z' }}"></i>{% endif %}
                        </a>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for contrato in contratos %}
                    {% set is_ativo = contrato.status_ativo %}
                    {% set data_fim = contrato.data_vigencia_fim %}
                    {# A variável 'hoje' deve ser passada pelo router para fazer esta verificação no frontend #}
                    {% set is_expirado = data_fim and data_fim < hoje %} 

                    <tr>
                        <td><a href="{{ url_for('detalhe_contrato', id_contrato=contrato.id) }}"><strong>{{ contrato.numero_contrato }}</strong></a></td>
                        <td>{{ contrato.processo_licitatorio }}</td>
                        <td>{{ contrato.fornecedor }}</td>
                        <td class="text-right">
                            {{ data_fim.strftime('%d/%m/%Y') if data_fim else 'N/D' }}
                            {# Aviso de expiração, mesmo se Ativo, pois pode precisar de aditivo #}
                            {% if is_expirado and is_ativo %}
                                <span class="status-badge orange" title="Contrato Ativo, mas Vigência Expirada">⚠️ Expirado</span>
                            {% elif is_expirado and not is_ativo %}
                                <span class="status-badge gray" title="Vigência Expirada">Expirado</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if is_ativo and not is_expirado %}
                                <span class="status-badge green">Ativo</span>
                            {% else %}
                                <span class="status-badge gray">Inativo</span>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div class="card-footer">
        {{ render_pagination(pagina_atual, total_paginas, 'contratos_ui', {}, query_params) }}
    </div>
    
    {% else %}
    <div class="empty-state">
        <i class="fa-solid fa-file-contract"></i>
        <h2>Nenhum Contrato Encontrado</h2>
        <p>Ajuste os filtros ou <a href="{{ url_for('novo_contrato_ui') }}">crie um novo contrato</a> para começar.</p>
    </div>
    {% endif %}

</div>
{% endblock %}