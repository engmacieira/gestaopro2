{% extends "base.html" %}

{% block title %}Novo Pedido - {{ categoria.nome }}{% endblock %}

{% block content %}
<div id="notification-area"></div>

<header class="main-header">
    {# Alterado url_for para request.app.url_path_for #}
    <a href="{{ request.app.url_path_for('contratos_por_categoria', id_categoria=categoria.id) }}" class="back-link">
        &larr; Voltar para o Catálogo
    </a>
    <h1>Novo Pedido: <span class="text-blue">{{ categoria.nome }}</span></h1>
    <p class="subtitle">Adicione itens do catálogo ao seu pedido.</p>
</header>

<div class="pedido-container">

    {# 1. INCLUSÃO DO NOVO COMPONENTE DE CATÁLOGO (Já verificado) #}
    {% include '_novo_pedido_catalogo.html' %}

    <div class="side-cart">
        <div class="card full-width">
            <div class="cart-header">
                <h2><i class="fa-solid fa-cart-shopping"></i> Pedido Atual</h2>
                <button id="btn-limpar-carrinho" class="btn-link-action red">Limpar</button>
            </div>
            <div id="carrinho-itens" class="cart-items-container">
                <div class="empty-state mini"><i class="fa-solid fa-dolly"></i><p>Seu carrinho está vazio.</p></div>
            </div>
            <div id="carrinho-total" class="cart-total">
                <span>Total Geral (AOCS):</span>
                <strong>R$ 0.00</strong>
            </div>
            <div class="cart-actions">
                <button id="btn-finalizar-pedido" class="btn btn-primary" style="width: 100%;" disabled>
                    <i class="fa-solid fa-check"></i> Finalizar Pedido
                </button>
            </div>
        </div>
    </div>
</div>

{# MODAL DE FINALIZAÇÃO (Mantido no corpo para simplificar) #}
<div id="modal-finalizar-pedido" class="modal-overlay">
    <div class="modal-content large">
        <div class="modal-header">
            <h2>Finalizar e Enviar Pedido</h2>
            <button id="btn-fechar-modal" class="close-button">&times;</button>
        </div>
        <form id="form-finalizar-pedido">
            <div class="modal-body">
                <p>Preencha os dados da AOCS. Se houver itens de múltiplos contratos no carrinho, será gerada uma AOCS para cada um.</p>

                <div class="form-grid">
                    <div class="form-group span-2">
                        <label for="aocs-unidade">Unidade Requisitante</label>
                        <select id="aocs-unidade" name="unidade_requisitante" class="form-control" required>
                            <option value="" disabled selected>Selecione...</option>
                            {% for unidade in unidades %}
                                <option value="{{ unidade }}">{{ unidade }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group span-2">
                        <label for="aocs-justificativa">Justificativa da Compra/Serviço</label>
                        <input type="text" id="aocs-justificativa" name="justificativa" class="form-control" required>
                    </div>

                    <div class="form-group span-2">
                        <label for="aocs-orcamento">Informação Orçamentária/Financeira</label>
                        <select id="aocs-orcamento" name="info_orcamentaria" class="form-control" required>
                            <option value="" disabled selected>Selecione...</option>
                            {% for dotacao in dotacoes %}
                                <option value="{{ dotacao }}">{{ dotacao }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group span-2">
                        <label for="aocs-local-entrega">Local de Entrega</label>
                        <select id="aocs-local-entrega" name="local_entrega" class="form-control" required>
                            <option value="" disabled selected>Selecione...</option>
                            {% for local in locais %}
                                <option value="{{ local }}">{{ local }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="aocs-responsavel">Agente Responsável</label>
                        <select id="aocs-responsavel" name="agente_responsavel" class="form-control" required>
                            <option value="" disabled selected>Selecione...</option>
                            {% for responsavel in responsaveis %}
                                <option value="{{ responsavel }}">{{ responsavel }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <hr style="width:100%; margin: 25px 0; border-color: var(--color-border);">

                <h4>Números das AOCS por Contrato</h4>
                <div id="aocs-por-contrato-container">
                    {# Conteúdo preenchido via JS #}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="btn-cancelar-modal" class="btn btn-secondary">Cancelar</button>
                <button type="button" id="btn-enviar-pedido" class="btn btn-primary">
                    <i class="fa-solid fa-paper-plane"></i> Confirmar e Enviar
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
{# Passa variáveis necessárias para o JavaScript externo #}
<script>
    const idCategoriaGlobal = {{ categoria.id }};
    const redirectUrlPedidosGlobal = "{{ request.app.url_path_for('pedidos_ui') }}";
</script>
{# Inclui o ficheiro JS externo #}
<script src="{{ request.app.url_path_for('static', path='js/novo_pedido.js') }}" defer></script>
{% endblock %}