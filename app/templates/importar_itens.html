{% extends "base.html" %}

{% block title %}Importar Itens para {{ contrato.numero_contrato }}{% endblock %}

{% block content %}
<div id="notification-area"></div>

<header class="main-header">
    <a href="{{ url_for('detalhe_contrato', id_contrato=contrato.id) }}" class="back-link">
        &larr; Voltar para os Detalhes do Contrato
    </a>
    <h1>Importar Itens para o Contrato</h1>
    <p class="subtitle">Contrato: <strong class="text-blue">{{ contrato.numero_contrato }}</strong></p>
</header>

{# INCLUSÃO DO COMPONENTE DE PASSOS #}
{% include '_importar_itens_steps.html' %} 

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    const formUpload = document.getElementById('form-upload-itens');
    const previewContainer = document.getElementById('preview-container');
    const previewTable = document.getElementById('preview-table');
    const errorMessageDiv = document.getElementById('error-message');
    const btnSalvar = document.getElementById('btn-salvar-dados');
    const notificationArea = document.getElementById('notification-area');
    
    const idContrato = {{ contrato.id }};
    let dadosParaSalvar = [];

    function showNotification(message, type = 'error') {
        const existing = notificationArea.querySelector('.notification');
        if(existing) existing.remove();
        
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        notificationArea.appendChild(notification);
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.addEventListener('transitionend', () => notification.remove());
        }, 5000);
    }

    function showNotificationAndReload(message, type = 'success') {
        sessionStorage.setItem('notificationMessage', message);
        sessionStorage.setItem('notificationType', type);
        window.location.reload();
    }
    
    // Exibir notificação após redirecionamento
    const msg = sessionStorage.getItem('notificationMessage');
    if (msg) {
        showNotification(msg, sessionStorage.getItem('notificationType'));
        sessionStorage.removeItem('notificationMessage');
        sessionStorage.removeItem('notificationType');
    }


    formUpload.addEventListener('submit', async function(event) {
        event.preventDefault();
        errorMessageDiv.innerText = '';
        previewContainer.style.display = 'none';

        const formData = new FormData(formUpload);
        const submitButton = formUpload.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Carregando...';

        try {
            // API CALL: Preview (POST /api/importar/itens/{id_contrato}/preview)
            const response = await fetch(`/api/importar/itens/${idContrato}/preview`, {
                method: 'POST',
                body: formData
            });
            const resultado = await response.json();
            
            if (!response.ok) throw new Error(resultado.detail || resultado.erro || 'Ocorreu um erro desconhecido.');
            
            dadosParaSalvar = resultado;
            renderizarPreview(dadosParaSalvar);
            
        } catch (error) {
            console.error('Erro no upload:', error);
            errorMessageDiv.innerText = `Erro: ${error.message}`;
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fa-solid fa-cloud-arrow-up"></i> Carregar e Pré-visualizar';
        }
    });

    function renderizarPreview(dados) {
        if (!dados || dados.length === 0) {
            errorMessageDiv.innerText = 'Nenhum dado válido encontrado na planilha.';
            return;
        }
        
        // UX Improvement: usa flex para exibir o container do passo 2
        previewContainer.style.display = 'flex'; 
        
        previewTable.innerHTML = '';
        
        // Headers são as chaves do JSON
        const headers = Object.keys(dados[0]); 
        let headerHTML = '<tr>';
        
        // Converte a chave para exibição (ex: numero_item -> Numero item)
        headers.forEach(h => headerHTML += `<th>${h.replace(/_/g, ' ')}</th>`);
        headerHTML += '</tr>';
        
        previewTable.createTHead().innerHTML = headerHTML;
        let bodyHTML = '';
        
        // Body (dados)
        dados.forEach(linha => {
            bodyHTML += '<tr>';
            headers.forEach(h => {
                let value = linha[h];
                
                // Formatação para evitar "null" no front e garantir legibilidade
                if (value === null || value === undefined) {
                    value = '';
                } else if (typeof value === 'number' && (h === 'quantidade' || h === 'valor_unitario')) {
                    // Formata números para o padrão brasileiro (virgula)
                    value = value.toFixed(2).replace('.', ',');
                }
                
                bodyHTML += `<td>${value}</td>`;
            });
            bodyHTML += '</tr>';
        });
        
        previewTable.createTBody().innerHTML = bodyHTML;
    }

    btnSalvar.addEventListener('click', async function() {
        if (dadosParaSalvar.length === 0) {
            showNotification('Não há dados para salvar.');
            return;
        }
        
        btnSalvar.disabled = true;
        btnSalvar.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Salvando...';
        
        try {
            // API CALL: Save (POST /api/importar/itens/{id_contrato}/salvar)
            const response = await fetch(`/api/importar/itens/${idContrato}/salvar`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dadosParaSalvar) 
            });
            const resultado = await response.json();
            
            if (!response.ok) throw new Error(resultado.detail || resultado.erro || 'Ocorreu um erro desconhecido ao salvar.');
            
            // Redireciona para a página de detalhes do contrato após o sucesso
            showNotificationAndReload(resultado.mensagem, 'success'); 

        } catch (error) {
            console.error('Erro ao salvar:', error);
            showNotification(`Erro: ${error.message}`);
            
            btnSalvar.disabled = false;
            btnSalvar.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Salvar Itens no Contrato';
        }
    });
});
</script>
{% endblock %}