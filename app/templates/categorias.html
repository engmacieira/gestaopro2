{% extends "base.html" %}
{% from '_pagination.html' import render_pagination %}

{% block title %}Gerenciar Categorias - GestãoPRO{% endblock %}

{% block content %}
<header class="main-header">
    <h1>Gerenciar Categorias</h1>
    <p class="subtitle">Adicione, visualize, edite ou exclua as categorias de contratos.</p>
</header>

<div class="card full-width">
    {# 1. INCLUSÃO DO COMPONENTE DA BARRA DE AÇÕES/FILTRO #}
    {% include '_categorias_action_bar.html' %}

    <div class="table-wrapper">
        <table class="data-table" id="tabela-categorias">
            <thead>
                <tr>
                    <th class="sortable-header" style="width: 10%;">
                        {% set next_order = 'desc' if sort_by == 'id' and order == 'asc' else 'asc' %}
                        {% set params = query_params.copy() %}
                        {% set _ = params.update({'sort_by': 'id', 'order': next_order}) %}
                        <a href="{{ url_for('categorias_ui', **params) }}">
                            ID
                            {% if sort_by == 'id' %}
                                <i class="fa-solid {{ 'fa-arrow-down-1-9' if order == 'desc' else 'fa-arrow-up-9-1' }}"></i>
                            {% endif %}
                        </a>
                    </th>

                    <th class="sortable-header">
                        {% set next_order = 'desc' if sort_by == 'nome' and order == 'asc' else 'asc' %}
                        {% set params = query_params.copy() %}
                        {% set _ = params.update({'sort_by': 'nome', 'order': next_order}) %}
                        <a href="{{ url_for('categorias_ui', **params) }}">
                            Nome
                            {% if sort_by == 'nome' %}
                                <i class="fa-solid {{ 'fa-arrow-down-z-a' if order == 'desc' else 'fa-arrow-up-a-z' }}"></i>
                            {% endif %}
                        </a>
                    </th>
                    
                    <th class="sortable-header" style="width: 15%;">
                        {% set next_order = 'desc' if sort_by == 'status' and order == 'asc' else 'asc' %}
                        {% set params = query_params.copy() %}
                        {% set _ = params.update({'sort_by': 'status', 'order': next_order}) %}
                        <a href="{{ url_for('categorias_ui', **params) }}">
                            Status
                             {% if sort_by == 'status' %}
                                <i class="fa-solid {{ 'fa-arrow-down-z-a' if order == 'desc' else 'fa-arrow-up-a-z' }}"></i>
                            {% endif %}
                        </a>
                    </th>

                    <th style="width: 25%;">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% if categorias %}
                    {% for cat in categorias %}
                    <tr class="{{ 'inactive-row' if not cat.ativo }}">
                        <td>{{ cat.id }}</td>
                        <td><a href="{{ url_for('contratos_por_categoria', id_categoria=cat.id) }}">{{ cat.nome }}</a></td>
                        <td>
                            {% if cat.ativo %}<span class="status-badge green">Ativo</span>
                            {% else %}<span class="status-badge gray">Inativo</span>{% endif %}
                        </td>
                        <td class="actions-cell">
                            <button class="btn-link-action" onclick="abrirModalParaEditar({{ cat.id }})"><i class="fa-solid fa-pencil"></i> Editar</button>
                            <button class="btn-link-action {{ 'red' if cat.ativo else 'green' }}" onclick="toggleStatusCategoria({{ cat.id }}, {{ 'true' if cat.ativo else 'false' }})"><i class="fa-solid fa-power-off"></i> {{ 'Inativar' if cat.ativo else 'Ativar' }}</button>
                            <button class="btn-link-action red" onclick="excluirCategoria({{ cat.id }})"><i class="fa-solid fa-trash-can"></i> Excluir</button>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="4"><div class="empty-state mini"><p>Nenhuma categoria encontrada.</p></div></td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <div class="card-footer">
        {{ render_pagination(pagina_atual, total_paginas, 'categorias_ui', query_params) }}
    </div>
</div>

{# 2. INCLUSÃO DO COMPONENTE MODAL #}
{% include '_categorias_modal.html' %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('modal-categoria');
    const modalTitulo = document.getElementById('modal-titulo');
    const formCategoria = document.getElementById('form-categoria');
    const inputNomeCategoria = document.getElementById('nome-categoria');
    const notificationArea = document.getElementById('notification-area');
    let idCategoriaEmEdicao = null;

    function showNotification(message, type = 'error') {
        const existing = notificationArea.querySelector('.notification');
        if(existing) existing.remove();
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        notificationArea.appendChild(notification);
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.addEventListener('transitionend', () => notification.remove());
        }, 5000);
    }
    
    function showNotificationAndReload(message, type = 'success') {
        // Usa sessionStorage para exibir notificação após o reload
        sessionStorage.setItem('notificationMessage', message);
        sessionStorage.setItem('notificationType', type);
        window.location.reload();
    }
    
    // Exibir notificação após redirecionamento
    const msg = sessionStorage.getItem('notificationMessage');
    if (msg) {
        showNotification(msg, sessionStorage.getItem('notificationType'));
        sessionStorage.removeItem('notificationMessage');
        sessionStorage.removeItem('notificationType');
    }

    const fecharModal = () => {
        modal.style.display = 'none';
        formCategoria.reset();
        idCategoriaEmEdicao = null;
    };
    
    document.getElementById('btn-abrir-modal').addEventListener('click', () => {
        idCategoriaEmEdicao = null;
        modalTitulo.innerText = 'Cadastrar Nova Categoria';
        formCategoria.reset();
        modal.style.display = 'flex';
    });
    
    document.getElementById('btn-fechar-modal').addEventListener('click', fecharModal);
    document.getElementById('btn-cancelar-modal').addEventListener('click', fecharModal);
    window.addEventListener('click', (event) => { if (event.target == modal) fecharModal(); });

    async function abrirModalParaEditar(id) {
        idCategoriaEmEdicao = id;
        try {
            // GET /api/categorias/{id}
            const response = await fetch(`/api/categorias/${id}`);
            const categoria = await response.json();
            
            // Tratamento de resposta da API
            if (!response.ok) throw new Error(categoria.detail || 'Categoria não encontrada.'); 
            
            modalTitulo.innerText = 'Editar Categoria';
            inputNomeCategoria.value = categoria.nome;
            modal.style.display = 'flex';
            
        } catch (error) {
            showNotification(`Erro ao buscar categoria: ${error.message}`);
        }
    }

    formCategoria.addEventListener('submit', async function(event) {
        event.preventDefault();
        const nome = inputNomeCategoria.value.trim();
        
        const url = idCategoriaEmEdicao ? `/api/categorias/${idCategoriaEmEdicao}` : '/api/categorias';
        const method = idCategoriaEmEdicao ? 'PUT' : 'POST';
        
        const submitButton = this.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        
        try {
            const response = await fetch(url, { 
                method, 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ nome: nome }) 
            });
            const resultado = await response.json();
            
            // Tratamento de erros de validação e integridade (FastAPI)
            if (!response.ok) throw new Error(resultado.detail || resultado.erro); 
            
            showNotificationAndReload(resultado.mensagem || `Categoria ${idCategoriaEmEdicao ? 'atualizada' : 'criada'} com sucesso!`, 'success');
            
        } catch (error) {
            showNotification(`Erro ao salvar: ${error.message}`);
        } finally {
            submitButton.disabled = false;
        }
    });

    // Função de status (PATCH /api/categorias/{id}/status?activate=...)
    window.toggleStatusCategoria = async (id, statusAtual) => {
        if (!confirm('Tem certeza que deseja alterar o status desta categoria?')) return;
        
        // Converte o status atual para o novo status booleano (true/false)
        const novoStatus = statusAtual === 'true' ? 'false' : 'true'; // Inverte o valor booleano
        
        try {
            // A API PATCH espera o parâmetro 'activate' na query
            const response = await fetch(`/api/categorias/${id}/status?activate=${novoStatus}`, { method: 'PATCH' });
            const resultado = await response.json();
            
            if (!response.ok) throw new Error(resultado.detail || resultado.erro);
            
            const acao = novoStatus === 'true' ? 'ativada' : 'inativada';
            showNotificationAndReload(resultado.mensagem || `Categoria ${acao} com sucesso!`, 'success');
            
        } catch(error) {
            showNotification(`Erro ao alterar status: ${error.message}`);
        }
    }

    // Função de exclusão (DELETE /api/categorias/{id})
    window.excluirCategoria = async (id) => {
        if (!confirm('ATENÇÃO: Ação permanente. Tem certeza que deseja excluir esta categoria?')) return;
        
        try {
            const response = await fetch(`/api/categorias/${id}`, { method: 'DELETE' });
            
            // O DELETE no FastAPI retorna 204 NO CONTENT em caso de sucesso
            if (response.status === 204) {
                 showNotificationAndReload("Categoria excluída com sucesso!", 'success');
                 return;
            }
            
            const resultado = await response.json();
            if (!response.ok) throw new Error(resultado.detail || resultado.erro);
            
        } catch(error) {
            showNotification(`Erro ao excluir: ${error.message}`);
        }
    }

    window.abrirModalParaEditar = abrirModalParaEditar;
});
</script>
{% endblock %}