{% extends "base.html" %}

{% block title %}Consultas Avançadas - GestãoPRO{% endblock %}

{% block content %}
<header class="main-header">
    <h1>Consultas Avançadas</h1>
    <p class="subtitle">Encontre contratos ou pedidos com base em seus vínculos no sistema.</p>
</header>

{# INCLUINDO O COMPONENTE DO FORMULÁRIO #}
{% include '_consultas_form.html' %}

<div id="area-resultados" style="margin-top: 30px;">
    <div class="empty-state"><i class="fa-solid fa-magnifying-glass"></i><h2>Aguardando sua consulta</h2><p>Selecione um tipo de consulta e um valor para buscar os resultados.</p></div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    const tipoConsultaSelect = document.getElementById('tipo-consulta');
    const valorConsultaContainer = document.getElementById('container-valor-consulta');
    const valorConsultaSelect = document.getElementById('valor-consulta');
    const valorConsultaLabel = document.getElementById('label-valor-consulta');
    const formConsulta = document.getElementById('form-consulta');
    const areaResultados = document.getElementById('area-resultados');
    
    // Objeto essencial para o mapeamento de colunas e URLs da API.
    const configEntidades = {{ entidades_pesquisaveis|tojson }}; 

    tipoConsultaSelect.addEventListener('change', async function() {
        const tipo = this.value;
        valorConsultaSelect.innerHTML = '<option value="">Carregando...</option>';
        valorConsultaSelect.disabled = true;

        if (!tipo) {
            valorConsultaContainer.style.display = 'none';
            return;
        }

        const config = configEntidades[tipo];
        valorConsultaLabel.innerText = config.label;
        valorConsultaContainer.style.display = 'block';

        try {
            // 1. Fetch dos valores disponíveis para o tipo de consulta
            const response = await fetch(`/api/consultas/entidades/${tipo}`);
            const data = await response.json();
            
            if (!response.ok) throw new Error(data.erro || 'Erro ao carregar opções.');

            valorConsultaSelect.innerHTML = '<option value="" disabled selected>Selecione...</option>';
            data.forEach(item => {
                // 'texto' e 'id' são os campos esperados da API 
                valorConsultaSelect.innerHTML += `<option value="${item.id}">${item.texto}</option>`; 
            });
            valorConsultaSelect.disabled = false;
            
        } catch (error) {
            valorConsultaSelect.innerHTML = '<option value="">Erro ao carregar</option>';
            console.error(error);
        }
    });

    formConsulta.addEventListener('submit', async function(event) {
        event.preventDefault();
        const tipo = tipoConsultaSelect.value;
        const valor = valorConsultaSelect.value;

        if (!tipo || !valor) { return; }

        areaResultados.innerHTML = '<div class="empty-state mini"><i class="fa-solid fa-spinner fa-spin"></i><p>Buscando...</p></div>';

        try {
            // 2. Fetch dos resultados da consulta
            const response = await fetch(`/api/consultas?tipo=${tipo}&valor=${valor}`);
            const data = await response.json();
            
            if (!response.ok) throw new Error(data.erro || 'Erro na consulta.');
            
            renderizarResultados(data);
            
        } catch (error) {
            areaResultados.innerHTML = `<p style="color: red;">${error.message}</p>`;
        }
    });
    
    // Função de renderização de resultados (USANDO CONFIGURAÇÃO DO BACKEND)
    function renderizarResultados(data) {
        if (!data.resultados || data.resultados.length === 0) {
            areaResultados.innerHTML = '<div class="empty-state mini"><p>Nenhum resultado encontrado.</p></div>';
            return;
        }

        // Mapeamento de colunas para renderização dinâmica
        const colunasMap = {
                    'processo_licitatorio': [
                        { header: 'Contrato', key: 'numero_contrato', link: '/contrato/' },
                        { header: 'Fornecedor', key: 'fornecedor' },
                        { header: 'Categoria', key: 'nome_categoria' },
                        { header: 'Status', key: 'ativo', format: (val) => `<span class="status-badge ${val ? 'green' : 'gray'}">${val ? 'Ativo' : 'Inativo'}</span>` }
                    ],
                    'unidade_requisitante': [ 
                        { header: 'AOCS', key: 'numero_aocs', link: '/pedido/' },
                        { header: 'Data', key: 'data_criacao' },
                        { header: 'Fornecedor', key: 'fornecedor' },
                        { header: 'Status', key: 'status_entrega', format: (val) => {
                             const statusClass = val === 'Entregue' ? 'green' : (val === 'Entrega Parcial' ? 'orange' : 'gray');
                             return `<span class="status-badge ${statusClass}">${val}</span>`;
                        }}
                    ],
                    'local_entrega': [
                        { header: 'AOCS', key: 'numero_aocs', link: '/pedido/' },
                        { header: 'Data', key: 'data_criacao' },
                        { header: 'Fornecedor', key: 'fornecedor' },
                         { header: 'Status', key: 'status_entrega', format: (val) => {
                             const statusClass = val === 'Entregue' ? 'green' : (val === 'Entrega Parcial' ? 'orange' : 'gray');
                             return `<span class="status-badge ${statusClass}">${val}</span>`;
                        }}
                    ],
                    'dotacao': [
                        { header: 'AOCS', key: 'numero_aocs', link: '/pedido/' },
                        { header: 'Data', key: 'data_criacao' },
                        { header: 'Fornecedor', key: 'fornecedor' },
                         { header: 'Status', key: 'status_entrega', format: (val) => {
                             const statusClass = val === 'Entregue' ? 'green' : (val === 'Entrega Parcial' ? 'orange' : 'gray');
                             return `<span class="status-badge ${statusClass}">${val}</span>`;
                        }}
                    ]
                };
        
        const colunas = colunasMap[data.tipo];
        if (!colunas) { areaResultados.innerHTML = '<p>Erro de configuração de renderização.</p>'; return; }

        let tableHtml = `
            <div class="card full-width">
                <h2>Resultados da Consulta (${data.resultados.length})</h2>
                <div class="table-wrapper"><table class="data-table">
                    <thead><tr>${colunas.map(c => `<th>${c.header}</th>`).join('')}</tr></thead>
                    <tbody>
        `;

        data.resultados.forEach(item => {
            tableHtml += '<tr>';
            colunas.forEach(col => {
                let valor = item[col.key];
                
                // Aplica formatação customizada
                if (col.format) {
                    valor = col.format(valor);
                } else if (valor === true) {
                     valor = 'Sim';
                } else if (valor === false) {
                     valor = 'Não';
                } else if (valor === null || valor === undefined) {
                     valor = 'N/D';
                }

                // Aplica link
                if (col.link) {
                    // Determina o valor do link: 'id' para Contrato, 'numero_aocs' para Pedido/AOCS
                    const linkValue = item.id !== undefined ? item.id : item.numero_aocs;
                    valor = `<a href="${col.link}${linkValue}"><strong>${valor}</strong></a>`;
                }
                
                tableHtml += `<td>${valor}</td>`;
            });
            tableHtml += '</tr>';
        });

        tableHtml += '</tbody></table></div></div>';
        areaResultados.innerHTML = tableHtml;
    }
});
</script>
{% endblock %}